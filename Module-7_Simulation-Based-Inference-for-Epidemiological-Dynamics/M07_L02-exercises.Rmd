---
title: 'Module 7: Lesson 2 Exercises'
author: "Callum Arnold"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up

## Loading packages and data

```{r}
library(doParallel)
library(doRNG)
library(tidyverse)
library(pomp)

registerDoParallel()
registerDoRNG(2488820)
```

```{r}
meas <- read_csv(paste0(
  "https://kingaa.github.io/sbied/stochsim/",
  "Measles_Consett_1948.csv"
  )) %>%
  select(week, reports = cases)
```

```{r}
plot(meas, type = "o")
```

## Setting up basic SIR model

As we've already gone through the process and intuition of setting up the model,
we'll just go straight to the C code.

```{r}
sir_step <- Csnippet("
  double dN_SI = rbinom(S, 1 - exp(-Beta * (I/N) * dt));
  double dN_IR = rbinom(I, 1 - exp(-mu_IR * dt));
  S -= dN_SI;
  I += dN_SI - dN_IR;
  R += dN_IR;
  H += dN_IR;
  ")
```

```{r}
sir_rinit <- Csnippet("
  S = nearbyint(eta * N);
  I = 1;
  R = nearbyint((1 - eta) * N);
  H = 0;
")
```

```{r}
sir_dmeas <- Csnippet("
  lik = dnbinom_mu(reports, k, rho * H, give_log);
  ")

sir_rmeas <- Csnippet("
  reports = rnbinom_mu(k, rho * H);
  ")
```

```{r}
measSIR <- meas %>% 
  pomp(
    times = "week", t0 = 0,
    rprocess = euler(sir_step, delta.t = 1/7),
    rinit = sir_rinit,
    rmeasure = sir_rmeas,
    dmeasure = sir_dmeas,
    accumvars = "H",
    statenames = c("S", "I", "R", "H"),
    paramnames = c("Beta", "mu_IR", "N", "eta", "rho", "k")
    )
```

```{r}
sims <- measSIR %>%
  simulate(
    params = c(
      Beta = 7.5, mu_IR = 0.5, rho = 0.5, k = 10,
      eta = 0.03, N = 38000
      ),
    nsim = 20, format = "data.frame", include.data = TRUE
  )
```

```{r}
sims %>%
  ggplot(aes(x = week, y = reports, group = .id, color = .id == "data")) +
  geom_line() +
  guides(color = FALSE)
```

# Exercises

## Exercise 2.3

> Fiddle with the parameters to see if you can't find a model for which the data
> are a more plausible realization.

## Exercise 2.4

> Below is a diagram of the so-called SEIR model. This differs from the SIR
> model in that infected individuals must pass a period of latency before
> becoming infectious.
>
> Modify the codes above to construct a pomp object containing the Consett
> measles data and an SEIR model. Perform simulations as above and adjust
> parameters to get a sense of whether improvement is possible by including a
> latent period.
